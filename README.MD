# Сервисное обслуживание 1с и Postgresql на Debian <!-- omit in toc -->
- [Статус](#статус)
- [1. Цель проекта](#1-цель-проекта)
- [2. Необходимые условия](#2-необходимые-условия)
- [3. Особенности реализации](#3-особенности-реализации)
    - [Пример *logrotate: /etc/logrotate.d/1cPSQLServ:*](#пример-logrotate-etclogrotated1cpsqlserv)
    - [Описание настроек - *config.yml:*](#описание-настроек---configyml)
- [4. Ссылки](#4-ссылки)
    - [Системные требования «1С:Предприятия 8»](#системные-требования-1спредприятия-8)
    - [Поддерживаемые версии PostgresPro](#поддерживаемые-версии-postgrespro)
    - [Автоматическая ротация log'ов с помощью logrotate](#автоматическая-ротация-logов-с-помощью-logrotate)
    - [Ошибка выгрузки таблицы "config"](#ошибка-выгрузки-таблицы-config)

## Статус

  На данный момент, проект можно считать работоспособным) Во всяком случае, задачу свою выполняет. Но использовать с пониманием, на свой стах и риск!
  
  Работа над проектом не закончена...

## 1. Цель проекта

Реализовать сценарий на python, который будет производить регулярные задачи по Crone для обслуживания сервера 1с в связке с БД Postgesql (BackUp БД и внешних томов 1с, Reindex, Vacuum, Чистку журналов 1с, проверки различные и т.п..). Предоставлять отчет о проделанной работе в виде журналов и сообщений в Telegram

## 2. Необходимые условия

  * Желание разобраться в этом безобразии)... 
  * Сам сервер на базе ОС Linux, с установленными и настроенными 1с и Postgresql
  * Установленный python (мин. 3.5)
  * Смонтированные внешние тома, если надо...
  
## 3. Особенности реализации

  Базовый дистрибутив хоста - Debian 9 (Согласно рекомендациям 1с - максимально рекомендуемый из Debian, на момент написания данного текста). Здесь все для Debian, но адаптировать под другую платформу, думаю, не составит большого труда. [таблицы совместимости 1с](#41-httpsv81crutekhnologiipostgrespro)

  Выполнение и все вызовы в скрипте производятся локально на сервере (не удаленно).
В данном случае sudo на сервере не установлен.

Решение состоит из:
= 1cPSQLServ.py - основной скрипт.
- Dispatcher.py - модуль диспетчера и логера в одном лице.
- Config.yml - настройки.
- *.tmpl - шаблоны с инструкциями для восстановления архивов

Работа приложения протоколируется. При ошибках на старте в 1cPSQLServ.log, пока config.yml не считан, далее в serv.log или как прописано в log/file: (в config.yml).
Журналы д.б. ротированы и соответствующая настройка logrotate произведена... ([Автоматическая ротация log'ов с помощью logrotate](https://www.opennet.ru/base/sys/logrotate_howto.txt.html))

#### Пример *logrotate: /etc/logrotate.d/1cPSQLServ:*
    /opt/serv/*.log {
          weekly
          rotate 3
          size=1M
          noolddir
          copytruncate
          delaycompress
          compress
          notifempty
          missingok
          su root root
    }

#### Описание настроек - *config.yml:*

    Description: Название набора заданий
    Host: xx.xx.xx.xx         # ip например, пока только для описания 
    SQLUserName: postgres     # Имя пользователя Postgresql
    1cServiceName: srv1cv83   # Имя сервиса 1с
    BackUp:                   
      Dir: /mnt/pg_arch/ARCH  # Раздел для архивов
    Do:
      - BackUp-SQL            # Реализованные в программе таски
      - Reindex-SQL           # Не трудно понять их смысл, подробней в 1cPSQLServ.py
      - Vacuum-SQL
      - BackUp-1cExtFiles
      - Clean-1cCache
      - FSCheck
      - Reboot
    BackUp-SQL:                           # По имени задач выше, параметры задач
      Depth: 1                            # Days - Хранить архивы баз X дней
      KeepQuantity: 5                     # Archives - Хранить минимум Х архивов (не трогать при удалении устаревших по настройке выше)
      RestoreManualTmpt: RestSQLManl.tmpt # Шаблон для инструкций 
      RestoreManualFile: README.MD        # Имя файла инструкций (ляжет в каталог с архивом базы, содержит описание и команды для восстановления)
    BackUp-Bases:                         
      - "GILV"                            # Собственно шаблоны - какие базы архивировать в Раздел для архивов, архивы лягут в папку с именем базы в виде каталога с шифром даты-времени-версии_архива.
      # - "%ERP%"
      # - "%BUH%"
      # - "%UPP%"
      # - "%ZUP%"
      # - "%ARCH%"
      - "%KA-%"  
    BackUp-1cExtFiles:
      1cExtFilesDir: /mnt/1cdata          # Внешние файлы 1с. Каталоги с именами как у баз. Т.е. если база имеет имя ERP-A, то и прикрепленные файлы должны лежать в /mnt/1cdata/ERP-A.
      Depth: 60 #Days                     # Глубина хранения изменений
      RestoreManualTmpt: RestFilesManl.tmpt # Шаблон для инструкций 
      RestoreManualFile: README.MD          # Имя файла инструкций (ляжет в каталог с архивом базы, содержит описание и команды для восстановления)

    Clean-1cCache:                        # В данной реализации, только удаляем в архив журналы...
      CacheDir: /home/usr1cv8/.1cv8/1C/1cv8/reg_1541  # Каталог где сервер хранит информации по базам
      LogDirName: 1Cv8Log                 # Имя каталога журналов
      LogArchDirName: 1cLogs              # Имя каталога для архивов журналов 1с в каталоге архивов базы
      LogDepth: 90        #Days           # Если дата каталога LogDirName станет старее LogDepth, журнал удалится в архив. 
      LogSizeMax: 1000    #MB             # Если размер каталога LogDirName станет больше LogSizeMax, журнал удалится в архив. 
      KeepDepth: 365      #Days           # Хранить архивы X дней
      KeepSizeMax: 6000   #MB             # Не больше такого размера

    FSCheck:
      MaxDiskSpaceUsage: 60 #%            # Для одноименной задачи, порог предупреждения заполнения томов.
    Reboot:
      TimeOut: 2  #min                    # Задержка перезагрузки для успешного завершения скрипта 

    log:
      file: "/opt/serv/serv.log"          # Куда логи пишем
      con: true                           # Вывод в консоль
      telegram:                           # Если настроено, получим в телегу отчет
        token: "xxxxxx"                   # Токен Вашего бота
        channel_id: "-xxxxxx"             # Ну понятно - id группы/канала
       

 SQL Архивы баз 1с состоят из двух файлов, конфигурация в отдельном. Причина - для таких конфигураций как УПП или КА, у которых она может быть более 1GB имеем pg_dump: Ошибка выгрузки таблицы "config": сбой в PQgetResult(). Т.к. PostgreSQL имеет ограничение 1Gb для одного поля... [Ошибка выгрузки таблицы "config"](https://forum.infostart.ru/forum34/topic205091/)
 
 В инструкции-шаблоне RestSQLManl описано как восстанавливать.

Выполнение задач из раздела настроек  "Do:" в программе записано в жестком порядке. Для задач, которые требуют остановки сервиса 1с, сервис на время выполнения задач будет остановлен, после запущен. Задачи будут выполняться, все, если это возможно.

Запускается скрипт по настройкам из Crone под root.
 Например (crontab -u root -e):

 37  23   *   *   *     cd /opt/serv && export PATH=$PATH:/usr/local/bin:/usr/lib/postgresql/12/bin && /opt/serv/1cPSQLServ.py -c config.yml
 
 (ну ... как есть, как у Вас не знаю). 
Здесь важно работать из основного каталога пакета и подтянуть пути к утилитам Postgresql


## 4. Ссылки
#### [Системные требования «1С:Предприятия 8»](https://v8.1c.ru/tekhnologii/sistemnye-trebovaniya-1s-predpriyatiya-8/)
#### [Поддерживаемые версии PostgresPro](https://v8.1c.ru/tekhnologii/postgrespro/)
#### [Автоматическая ротация log'ов с помощью logrotate](https://www.opennet.ru/base/sys/logrotate_howto.txt.html)
#### [Ошибка выгрузки таблицы "config"](https://forum.infostart.ru/forum34/topic205091/)

